// prisma/schema.prisma

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// Model User cho xác thực
model User {
  id        String   @id @default(cuid())
  username  String   @unique
  password  String   // bcrypt hashed
  role      UserRole @default(PROPERTY_OWNER)
  isActive  Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  
  // Quan hệ
  propertyOwnerships PropertyOwnership[]
  
  @@index([role])
  @@index([isActive])
}

// Thông tin nhà trọ (legacy - giữ lại để tương thích ngược)
model PropertyInfo {
  id                String   @id @default(cuid())
  name              String
  address           String
  phone             String
  ownerName         String
  email             String?
  logoUrl           String?  // Cloudinary URL
  maxElectricMeter  Int      @default(999999)  // Giá trị tối đa đồng hồ điện (6 chữ số)
  maxWaterMeter     Int      @default(99999)  // Giá trị tối đa đồng hồ nước (5 chữ số)
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt
}

// Model Property cho multi-tenant (extends PropertyInfo concept)
model Property {
  id                String   @id @default(cuid())
  name              String
  address           String
  phone             String
  ownerName         String
  email             String?
  logoUrl           String?  // Cloudinary URL
  maxElectricMeter  Int      @default(999999)  // Giá trị tối đa đồng hồ điện (6 chữ số)
  maxWaterMeter     Int      @default(99999)  // Giá trị tối đa đồng hồ nước (5 chữ số)
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt
  
  // Quan hệ
  propertyOwnerships PropertyOwnership[]
  rooms             Room[]
  feeTypes          FeeType[]
  utilityRates      UtilityRate[]
  
  @@index([name])
}

// Junction table cho User-Property many-to-many relationship
model PropertyOwnership {
  id         String   @id @default(cuid())
  userId     String
  propertyId String
  createdAt  DateTime @default(now())
  
  // Quan hệ
  user       User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  property   Property @relation(fields: [propertyId], references: [id], onDelete: Cascade)
  
  @@unique([userId, propertyId])
  @@index([userId])
  @@index([propertyId])
}

// Model Phòng
model Room {
  id                String    @id @default(cuid())
  code              String    // Mã phòng (A101, A102, etc.)
  name              String
  price             Decimal   @db.Decimal(10, 0)
  status            RoomStatus @default(EMPTY)
  meterReadingDay   Int?      // Ngày chốt số hàng tháng (1-31)
  maxElectricMeter  Int?      // Override giá trị max đồng hồ điện cho phòng này (null = dùng chung)
  maxWaterMeter     Int?      // Override giá trị max đồng hồ nước cho phòng này (null = dùng chung)
  propertyId        String?   // Foreign key to Property (nullable for migration)
  createdAt         DateTime  @default(now())
  updatedAt         DateTime  @updatedAt
  
  // Quan hệ
  property          Property? @relation(fields: [propertyId], references: [id], onDelete: Cascade)
  tenant            Tenant?
  utilityRates      UtilityRate?
  bills             Bill[]
  roomFees          RoomFee[]
  
  @@unique([propertyId, code]) // Mã phòng unique trong từng property (propertyId có thể null trong migration)
  @@index([status])
  @@index([code])
  @@index([propertyId])
}

enum RoomStatus {
  EMPTY     // Phòng trống
  OCCUPIED  // Đã thuê
}

enum WaterPricingMethod {
  METER   // Theo đồng hồ
  PERSON  // Theo số người
}

enum ResidenceType {
  TEMPORARY  // Tạm trú
  PERMANENT  // Thường trú
}

enum DepositReturnMethod {
  FULL_RETURN           // Hoàn trả đầy đủ
  DEDUCT_FROM_LAST_BILL // Trừ vào hóa đơn cuối
}

enum UserRole {
  SUPER_ADMIN     // Quản trị viên hệ thống
  PROPERTY_OWNER  // Chủ nhà trọ
}

// Đơn giá điện nước (chung và riêng từng phòng)
model UtilityRate {
  id                    String    @id @default(cuid())
  electricityPrice      Decimal?  @db.Decimal(10, 0)  // VNĐ/kWh
  waterPrice            Decimal?  @db.Decimal(10, 0)  // VNĐ/m³
  waterPricingMethod    WaterPricingMethod @default(METER)
  waterPricePerPerson   Decimal?  @db.Decimal(10, 0)  // VNĐ/người/tháng
  useTieredPricing      Boolean   @default(false)
  isGlobal              Boolean   @default(false)
  propertyId            String?   // Foreign key to Property (nullable for migration)
  createdAt             DateTime  @default(now())
  updatedAt             DateTime  @updatedAt
  
  // Quan hệ
  property              Property? @relation(fields: [propertyId], references: [id], onDelete: Cascade)
  // Quan hệ (cho đơn giá riêng từng phòng)
  roomId                String?   @unique
  room                  Room?     @relation(fields: [roomId], references: [id], onDelete: Cascade)
  
  // Bậc thang giá điện
  tieredRates           TieredElectricityRate[]
  
  @@index([isGlobal])
  @@index([roomId])
  @@index([propertyId])
}

// Bậc thang giá điện
model TieredElectricityRate {
  id              String    @id @default(cuid())
  minUsage        Int       // kWh
  maxUsage        Int?      // kWh (null = không giới hạn)
  price           Decimal   @db.Decimal(10, 0)
  createdAt       DateTime  @default(now())
  
  // Quan hệ
  utilityRateId   String
  utilityRate     UtilityRate @relation(fields: [utilityRateId], references: [id], onDelete: Cascade)
  
  @@index([utilityRateId])
}

// Model Người thuê chính
model Tenant {
  id              String    @id @default(cuid())
  fullName        String
  phone           String
  idCard          String?
  dateOfBirth     DateTime?
  hometown        String?
  moveInDate      DateTime?
  deposit         Decimal?  @db.Decimal(10, 0)
  contractFileUrl String?   // Cloudinary URL
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt
  deletedAt       DateTime?
  deletedBy       String?
  deleteReason    String?
  
  // Quan hệ
  roomId          String?    @unique
  room            Room?      @relation(fields: [roomId], references: [id])
  occupants       Occupant[]
  depositReturns  DepositReturn[]
  
  @@index([deletedAt])
  @@index([roomId])
  @@index([phone])
}

// Model Người ở
model Occupant {
  id              String    @id @default(cuid())
  fullName        String
  idCard          String?
  dateOfBirth     DateTime?
  hometown        String?
  relationship    String?   // Quan hệ với người thuê chính
  residenceType   ResidenceType @default(TEMPORARY)
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt
  
  // Quan hệ
  tenantId        String
  tenant          Tenant    @relation(fields: [tenantId], references: [id])
  
  @@index([tenantId])
}

// Lịch sử hoàn trả cọc
model DepositReturn {
  id              String    @id @default(cuid())
  amount          Decimal   @db.Decimal(10, 0)
  returnDate      DateTime  @default(now())
  method          DepositReturnMethod
  notes           String?
  createdAt       DateTime  @default(now())
  
  // Quan hệ
  tenantId        String
  tenant          Tenant    @relation(fields: [tenantId], references: [id])
  
  @@index([tenantId])
}

// Model Hóa đơn
model Bill {
  id                    String    @id @default(cuid())
  month                 Int       // 1-12
  year                  Int
  
  // Chỉ số đồng hồ
  oldElectricReading    Int
  newElectricReading    Int
  electricityUsage      Int
  electricityRollover   Boolean   @default(false)
  
  oldWaterReading       Int
  newWaterReading       Int
  waterUsage            Int
  waterRollover         Boolean   @default(false)
  
  // Ảnh đồng hồ (Cloudinary URLs)
  electricMeterPhotoUrl String?
  waterMeterPhotoUrl    String?
  
  // Chi phí
  roomPrice             Decimal   @db.Decimal(10, 0)
  electricityCost       Decimal   @db.Decimal(10, 0)
  waterCost             Decimal   @db.Decimal(10, 0)
  totalCost             Decimal   @db.Decimal(10, 0)
  totalCostText         String    // Số tiền bằng chữ
  
  // Trạng thái
  isPaid                Boolean   @default(false)
  paidAmount            Decimal?  @db.Decimal(10, 0)  // Số tiền đã thanh toán (null = chưa thanh toán, < totalCost = thanh toán một phần)
  paidDate              DateTime?
  notes                 String?
  
  // Thông tin người thuê (snapshot tại thời điểm tạo hóa đơn, không dùng foreign key)
  tenantName            String?
  tenantPhone           String?
  tenantDateOfBirth     DateTime?
  tenantIdCard          String?
  
  createdAt             DateTime  @default(now())
  updatedAt             DateTime  @updatedAt
  
  // Quan hệ
  roomId                String
  room                  Room      @relation(fields: [roomId], references: [id])
  billFees              BillFee[]
  
  @@unique([roomId, month, year])
  @@index([roomId])
  @@index([isPaid])
  @@index([month, year])
}

// Loại phí (Wifi, rác, gửi xe, v.v.)
model FeeType {
  id            String    @id @default(cuid())
  name          String    // Wifi, Tiền rác, Tiền gửi xe, etc.
  description   String?   // Mô tả phí
  isActive      Boolean   @default(true) // Có hiển thị trong danh sách không
  propertyId    String?   // Foreign key to Property (nullable for migration)
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt
  
  // Quan hệ
  property      Property? @relation(fields: [propertyId], references: [id], onDelete: Cascade)
  roomFees      RoomFee[]
  
  @@unique([propertyId, name]) // Tên phí unique trong từng property (propertyId có thể null trong migration)
  @@index([isActive])
  @@index([propertyId])
}

// Phí được gán cho từng phòng
model RoomFee {
  id          String    @id @default(cuid())
  amount      Decimal   @db.Decimal(10, 0) // Số tiền cho phòng này
  isActive    Boolean   @default(true) // Có áp dụng cho phòng này không
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  
  // Quan hệ
  roomId      String
  room        Room      @relation(fields: [roomId], references: [id], onDelete: Cascade)
  feeTypeId   String
  feeType     FeeType   @relation(fields: [feeTypeId], references: [id], onDelete: Cascade)
  
  @@unique([roomId, feeTypeId]) // Mỗi phòng chỉ có 1 mức phí cho 1 loại phí
  @@index([roomId])
  @@index([feeTypeId])
  @@index([isActive])
}

// Phí thực tế trong hóa đơn (snapshot tại thời điểm tạo bill)
model BillFee {
  id          String    @id @default(cuid())
  name        String    // Tên phí (snapshot từ FeeType tại thời điểm tạo)
  amount      Decimal   @db.Decimal(10, 0) // Số tiền thực tế (snapshot)
  feeTypeId   String?   // ID tham chiếu (chỉ để biết nguồn gốc, không dùng relation)
  createdAt   DateTime  @default(now())
  
  // Quan hệ
  billId      String
  bill        Bill      @relation(fields: [billId], references: [id], onDelete: Cascade)
  
  @@index([billId])
}

// Model ReportTemplate (đã có trong database từ migration trước)
enum ReportType {
  BILL_BASIC
  BILL_DETAILED
  BILL_OFFICIAL
  REPORT_BASIC
  REPORT_DETAILED
}

model ReportTemplate {
  id          String     @id @default(cuid())
  name        String
  type        ReportType
  logoUrl     String?
  primaryColor String?
  isDefault   Boolean    @default(false)
  createdAt   DateTime   @default(now())
  updatedAt   DateTime   @updatedAt
  
  @@unique([name, type])
  @@index([type])
  @@index([isDefault])
}